<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/imagens/icone.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>Controle de Gastos</title>
    <style>
        .header {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .add-button, .remove-button {
            cursor: pointer;
        }
        input[type="number"].currency:invalid {
            border: 1px solid red;
        }
        #chart-container {
            width: 100%;
            max-width: 600px;
            margin: auto;
        }
        .home {
            position: relative;
            left: 30%;
            top: 100px;
        }
        .balance {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 20px;
        }
        .warning {
            color: red;
            font-weight: bold;
            margin: 10px 0;
        }
        .over-budget {
            background-color: #f8d7da; /* Light red background */
            color: #721c24; /* Dark red text */
        }
    </style>
</head>
<body>
    
    <nav class="menu-lateral">
        <link rel='stylesheet' media='screen' href='../../css/indice/indice.css'> 
        <div class="btn-expandir">
            <h1>Índice</h1>
        </div>
        <div class="cor_azul"></div>
        <ul>
            <li class="item-menu"><a href="perfil.html">
                <span class="icon"> <i class="bi bi-person"></i></span>
                <span class="txt-link">Perfil</span>
            </a></li>
            <li class="item-menu"><a href="home.html">
                <span class="icon"><i class="bi bi-house-door"></i></span>
                <span class="txt-link">Início</span>
            </a></li>
            <li class="item-menu"><a href="mes.html">
                <span class="icon"><i class="bi bi-coin"></i></span>
                <span class="txt-link">Gastos do mês</span>
            </a></li>
            <li class="item-menu"><a href="objetivos.html">
                <span class="icon"><i class="bi bi-bar-chart"></i></span>
                <span class="txt-link">Objetivos</span>
            </a></li>
            <li class="item-menu"><a href="anual.html">
                <span class="icon"><i class="bi bi-calendar-check"></i></span>
                <span class="txt-link">Visão Anual</span>
            </a></li>
            <li class="item-menu"><a href="configuracoes.html">
                <span class="icon"><i class="bi bi-gear"></i></span>
                <span class="txt-link">Configurações</span>
            </a></li>
        </ul>
    </nav>

    <div class="home">
        <!-- Seção para o valor recebido -->
        <div class="section" id="entry-section">
            <div class="header">ENTRADA</div>
            <div>
                <input type="number" id="entry-amount" placeholder="Valor">
                <button class="add-button" onclick="addEntry()">Adicionar Entrada</button>
            </div>
            <div id="entry-output">
                <table>
                    <thead>
                        <tr>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody id="entry-output-body"></tbody>
                </table>
                <div>Total de Entradas: R$ <span id="total-entry-amount">0.00</span></div>
            </div>
        </div>

        <!-- Seção para despesas por categoria -->
        <div class="section" id="category-expenses">
            <div class="header">GASTOS POR CATEGORIA</div>
            <table>
                <thead>
                    <tr>
                        <th>Categoria</th>
                        <th>Limite de gastos</th>
                        <th>Valor gasto</th>
                        <th>Porcentagem</th>
                    </tr>
                </thead>
                <tbody id="category-expenses-body"></tbody>
            </table>
            <div>
                <button class="add-button" onclick="addCategoryRow()">Adicionar Categoria</button>
            </div>
        </div>

        <!-- Seção para despesas mensais -->
        <div class="section" id="monthly-expenses">
            <div class="header">GASTOS MENSAL</div>
            <table>
                <thead>
                    <tr>
                        <th>Nome do gasto</th>
                        <th>Data de pagamento</th>
                        <th>Categoria</th>
                        <th>Valor</th>
                        <th>Pago</th>
                        <th>Categoria de Pagamento</th>
                        <th>Remover</th>
                    </tr>
                </thead>
                <tbody id="monthly-expenses-body"></tbody>
            </table>
            <div>
                <button class="add-button" onclick="addFixedExpenseRow()">Adicionar Gasto Fixo</button>
            </div>
        </div>

        <!-- Seção para saída de gastos -->
        <div class="section" id="expense-output">
            <div class="header">SAÍDA</div>
            <table>
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody id="expense-output-body"></tbody>
            </table>
            <div id="total-expense">
                Total gasto: R$ <span id="total-expense-amount">0.00</span>
            </div>
        </div>

        <!-- Container para o gráfico de despesas -->
        <div id="chart-container">
            <canvas id="expenseChart"></canvas>
        </div>

        <!-- Seção para saldo disponível -->
        <div class="balance" id="balance">Saldo Disponível: R$ 0.00</div>

        <!-- Seção para avisos de limite -->
        <div id="warnings-container" class="warning"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let expenseChart;
        let totalEntries = 0;
        let currentBalance = 0;
        const categoryColors = {};

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function addFixedExpenseRow() {
            let tableBody = document.getElementById("monthly-expenses-body");
            let newRow = tableBody.insertRow();
            newRow.insertCell().innerHTML = '<input type="text" placeholder="Nome do gasto">';
            newRow.insertCell().innerHTML = '<input type="date">';
            newRow.insertCell().innerHTML = generateCategoryDropdown();
            newRow.insertCell().innerHTML = '<input type="number" placeholder="Valor" oninput="updateCategoryExpenses()">';
            newRow.insertCell().innerHTML = '<input type="checkbox" onclick="updateCategoryExpenses(); updateBalance()">';
            newRow.insertCell().innerHTML = generatePaymentCategoryDropdown();
            newRow.insertCell().innerHTML = '<button class="remove-button" onclick="deleteFixedExpenseRow(this)">Remover</button>';
        }

        function deleteFixedExpenseRow(button) {
            let row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
            updateCategoryExpenses();
            updateBalance();
        }

        function addCategoryRow() {
            let tableBody = document.getElementById("category-expenses-body");
            let newRow = tableBody.insertRow();
            newRow.insertCell().innerHTML = '<input type="text" placeholder="Categoria" oninput="updateCategoryDropdown()">';
            newRow.insertCell().innerHTML = '<input type="text" class="currency" placeholder="Limite" onblur="formatCurrency(this); updateCategoryExpenses()">';
            newRow.insertCell().innerHTML = '<input type="number" placeholder="Gasto" readonly>';
            newRow.insertCell().innerHTML = '<input type="text" placeholder="Porcentagem" readonly>';
            newRow.insertCell().innerHTML = '<button class="remove-button" onclick="deleteRow(this)">Remover</button>';
            updateCategoryDropdown();
        }

        function deleteRow(button) {
            let row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
            updateCategoryExpenses();
            updateBalance();
        }

        function updateCategoryExpenses() {
            let categoryExpensesBody = document.getElementById("category-expenses-body");
            let monthlyExpensesBody = document.getElementById("monthly-expenses-body");

            let categoryData = {};
            let warnings = [];

            for (let i = 0; i < categoryExpensesBody.rows.length; i++) {
                let cells = categoryExpensesBody.rows[i].cells;
                let category = cells[0].getElementsByTagName("input")[0].value;
                let limit = parseFloat(cells[1].getElementsByTagName("input")[0].value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
                categoryData[category] = { limit: limit, spent: 0 };
            }

            for (let i = 0; i < monthlyExpensesBody.rows.length; i++) {
                let cells = monthlyExpensesBody.rows[i].cells;
                let category = cells[2].getElementsByTagName("select")[0].value;
                let value = parseFloat(cells[3].getElementsByTagName("input")[0].value) || 0;
                let isPaid = cells[4].getElementsByTagName("input")[0].checked;
                if (isPaid && categoryData[category]) {
                    categoryData[category].spent += value;
                }
            }

            let labels = [];
            let data = [];
            let colors = [];
            warnings = [];

            for (let i = 0; i < categoryExpensesBody.rows.length; i++) {
                let cells = categoryExpensesBody.rows[i].cells;
                let category = cells[0].getElementsByTagName("input")[0].value;
                if (categoryData[category]) {
                    let spent = categoryData[category].spent;
                    let limit = categoryData[category].limit;
                    let percentage = (limit === 0) ? 0 : (spent / limit) * 100;
                    cells[2].getElementsByTagName("input")[0].value = spent.toFixed(2);
                    cells[3].getElementsByTagName("input")[0].value = percentage.toFixed(2) + '%';
                    labels.push(category);
                    data.push(spent);
                    if (percentage > 100) {
                        warnings.push(`Atenção: A categoria "${category}" ultrapassou o limite de R$ ${limit.toFixed(2)}.`);
                        // Exibir alerta com `alert`
                        alert("Categoria ultrapassou o limite.");
                        // Mudar a cor da categoria para vermelho
                        cells[0].getElementsByTagName("input")[0].classList.add('over-budget');
                    } else {
                        cells[0].getElementsByTagName("input")[0].classList.remove('over-budget');
                    }
                    if (!categoryColors[category]) {
                        categoryColors[category] = getRandomColor();
                    }
                    colors.push(categoryColors[category]);
                }
            }

            if (expenseChart) {
                expenseChart.destroy();
            }

            const ctx = document.getElementById('expenseChart').getContext('2d');
            expenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gastos',
                        data: data,
                        backgroundColor: colors,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    return `R$ ${tooltipItem.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return `R$ ${value}`;
                                }
                            }
                        }
                    }
                },
            });

            // Atualizar avisos
            document.getElementById('warnings-container').innerHTML = warnings.join('<br>');
        }

        function updateCategoryDropdown() {
            let categoryExpensesBody = document.getElementById("category-expenses-body");
            let monthlyExpensesBody = document.getElementById("monthly-expenses-body");
            let categoryOptions = "";

            for (let i = 0; i < categoryExpensesBody.rows.length; i++) {
                let category = categoryExpensesBody.rows[i].cells[0].getElementsByTagName("input")[0].value;
                if (category) {
                    categoryOptions += `<option value="${category}">${category}</option>`;
                }
            }

            for (let i = 0; i < monthlyExpensesBody.rows.length; i++) {
                let categorySelect = monthlyExpensesBody.rows[i].cells[2].getElementsByTagName("select")[0];
                categorySelect.innerHTML = categoryOptions;
            }
        }

        function updateBalance() {
            let totalExpenses = 0;
            let totalEntries = parseFloat(document.getElementById('total-entry-amount').innerText.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            let monthlyExpensesBody = document.getElementById("monthly-expenses-body");

            for (let i = 0; i < monthlyExpensesBody.rows.length; i++) {
                let cells = monthlyExpensesBody.rows[i].cells;
                let value = parseFloat(cells[3].getElementsByTagName("input")[0].value) || 0;
                let isPaid = cells[4].getElementsByTagName("input")[0].checked;
                if (isPaid) {
                    totalExpenses += value;
                }
            }

            currentBalance = totalEntries - totalExpenses;
            document.getElementById('balance').textContent = `Saldo Disponível: R$ ${currentBalance.toFixed()}`;

            // Update expense output
            updateExpenseOutput(totalExpenses);
        }

        function updateExpenseOutput(totalExpenses) {
            let expenseOutputBody = document.getElementById("expense-output-body");
            expenseOutputBody.innerHTML = '';

            let rows = document.querySelectorAll('#monthly-expenses-body tr');
            let totalExpense = 0;

            rows.forEach(row => {
                let cells = row.cells;
                let category = cells[2].getElementsByTagName("select")[0].value;
                let value = parseFloat(cells[3].getElementsByTagName("input")[0].value) || 0;
                let isPaid = cells[4].getElementsByTagName("input")[0].checked;
                let paymentCategory = cells[5].getElementsByTagName("select")[0].value;

                if (isPaid) {
                    let newRow = expenseOutputBody.insertRow();
                    newRow.insertCell().innerText = `${category} (${paymentCategory})`;
                    newRow.insertCell().innerText = `R$ ${value.toFixed(2)}`;
                    totalExpense += value;
                }
            });

            document.getElementById('total-expense-amount').innerText = totalExpense.toFixed(2);
        }

        function formatCurrency(input) {
            let value = parseFloat(input.value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            input.value = value.toFixed(2);
        }

        function generateCategoryDropdown() {
            let categoryOptions = "";
            let categoryExpensesBody = document.getElementById("category-expenses-body");
            for (let i = 0; i < categoryExpensesBody.rows.length; i++) {
                let category = categoryExpensesBody.rows[i].cells[0].getElementsByTagName("input")[0].value;
                if (category) {
                    categoryOptions += `<option value="${category}">${category}</option>`;
                }
            }
            return `<select>${categoryOptions}</select>`;
        }

        function addEntry() {
            let amount = parseFloat(document.getElementById('entry-amount').value) || 0;

            if (amount > 0) {
                let entryOutputBody = document.getElementById("entry-output-body");
                let newRow = entryOutputBody.insertRow();
                newRow.insertCell().innerText = `R$ ${amount.toFixed(2)}`;

                totalEntries += amount;
                document.getElementById('total-entry-amount').innerText = totalEntries.toFixed(2);

                // Clear input
                document.getElementById('entry-amount').value = '';

                updateBalance();
            }
        }

        function generatePaymentCategoryDropdown() {
            return `
                <select>
                    <option value="Débito">Débito</option>
                    <option value="Crédito">Crédito</option>
                    <option value="Outro">Outro</option>
                </select>`;
        }
    </script>
</body>
</html>
